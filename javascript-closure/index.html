<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4274798044223706"
      crossorigin="anonymous"></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/apple-icon.png" color="#222">
  <link rel="manifest" href="/images/manifest.json">
  <meta name="msapplication-config" content="/images/browserconfig.xml">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<script data-ad-client="ca-pub-4274798044223706" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4274798044223706"
  crossorigin="anonymous"></script>

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-flash.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"heidiliu2020.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":true,"sidebar":{"position":"right","Pisces | Gemini":200,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6F0SL2XTQY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6F0SL2XTQY');
</script>

  <meta name="description" content="本篇為 [JS201] 進階 JavaScript：那些你一直搞不懂的地方 這門課程的學習筆記。如有錯誤歡迎指正！">
<meta property="og:type" content="article">
<meta property="og:title" content="[week 16] JavaScript 進階 - 什麼是閉包？探討 Closure &amp; Scope Chain">
<meta property="og:url" content="https://heidiliu2020.github.io/javascript-closure/index.html">
<meta property="og:site_name" content="前端新米">
<meta property="og:description" content="本篇為 [JS201] 進階 JavaScript：那些你一直搞不懂的地方 這門課程的學習筆記。如有錯誤歡迎指正！">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/RtkT8LP.png">
<meta property="og:image" content="https://i.imgur.com/9ROutJb.png">
<meta property="article:published_time" content="2020-10-19T16:25:00.000Z">
<meta property="article:modified_time" content="2020-12-29T15:05:05.093Z">
<meta property="article:author" content="Heidi Liu">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="Closure">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/RtkT8LP.png">

<link rel="canonical" href="https://heidiliu2020.github.io/javascript-closure/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>[week 16] JavaScript 進階 - 什麼是閉包？探討 Closure & Scope Chain | 前端新米</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6F0SL2XTQY"></script>
    <script data-pjax>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-6F0SL2XTQY');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">前端新米</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Heidi's Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-首頁">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-文章分類">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>文章分類</a>

  </li>
        <li class="menu-item menu-item-文章列表">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>文章列表</a>

  </li>
        <li class="menu-item menu-item-關於我">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>關於我</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://heidiliu2020.github.io/javascript-closure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/65410665?s=460&u=887bd602944dcf78b90f3a880b03aec4e086728a&v=4">
      <meta itemprop="name" content="Heidi Liu">
      <meta itemprop="description" content="海底修羅場｜日々進化中">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="前端新米">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [week 16] JavaScript 進階 - 什麼是閉包？探討 Closure & Scope Chain
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-10-20 00:25:00" itemprop="dateCreated datePublished" datetime="2020-10-20T00:25:00+08:00">2020-10-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-12-29 23:05:05" itemprop="dateModified" datetime="2020-12-29T23:05:05+08:00">2020-12-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>本篇為 <span class="exturl" data-url="aHR0cHM6Ly9saWRlbXkuY29tL3AvanMyMDEtamF2YXNjcmlwdA==">[JS201] 進階 JavaScript：那些你一直搞不懂的地方<i class="fa fa-external-link-alt"></i></span> 這門課程的學習筆記。如有錯誤歡迎指正！</p>
</blockquote>
<span id="more"></span>

<p>在上一篇筆記 <span class="exturl" data-url="aHR0cHM6Ly9oYWNrbWQuaW8vQEhlaWRpLUxpdS9ub3RlLWpzMjAxLXNjb3BlLWhvaXN0aW5n">[week 16] JavaScript 進階 - 初探 Hoisting &amp; Execution Context<i class="fa fa-external-link-alt"></i></span> 中，我們談到 Hoisting（提升）、Execution Context（執行環境）等相關概念。</p>
<p>瞭解到每一個 function 會有一個對應的執行環境，裡面負責存放該環境需要用到的各種資料，由這些參數組成 Variable Object（變數物件）。</p>
<p>包括之前談過的 VO，每個執行環境會有下列三個屬性：</p>
<ul>
<li>作用域鏈（Scope Chain）</li>
<li>變數物件（Variable Object）</li>
<li>‘this’ 變數（‘this’ Variable）</li>
</ul>
<p>而當中的作用域鏈（Scope Chain）其實就和本篇所要探討的 Closure（閉包）有關，因此下面會先從 Scope（作用域）開始講起。</p>
<pre class="line-numbers language-none"><code class="language-none">學習目標：

 P1 你知道什麼是作用域（Scope）
 P1 你知道 Closure（閉包）是什麼
 P1 你能夠舉出一個運用 Closure 的例子<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="Scope-作用域"><a href="#Scope-作用域" class="headerlink" title="Scope 作用域"></a>Scope 作用域</h2><p>什麼是 Scope（作用域）？簡言之，就是「一個變數的生存範圍」，一旦出了這個範圍，就會無法存取到這個變數。</p>
<p>舉個簡單的例子，如果在 test() 中以 var 宣告變數 a，在 function 作用域之外會無法存取該變數：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span>
<span class="token punctuation">&#125;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token comment">// Uncaught ReferenceError: a is not defined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 ES6 以前，唯一產生作用域的方法就是宣告 function，每一個 function 都有自己的作用域，在作用域外就存取不到這個 function 內部所定義的變數。</p>
<p>在 ES6 出現以後，作用域的概念有些改變，也就是引入 let 跟 const 的宣告，可用大括號 <code>&#123;...&#125;</code> 來定義 block（區塊）作用域。</p>
<p>因此 JavaScript 的作用域其實可分為三個層級：</p>
<ul>
<li>Global Level Scope：全域作用域</li>
<li>Function Level Scope：函式作用域</li>
<li>Block Level Scope（ES6）：區塊作用域</li>
</ul>
<p>也就是說，變數作用域的範圍，其實就取決於這個變數的宣告方式，以及在哪進行宣告。</p>
<p>而根據變數是在哪宣告，又可分為全域變數和區域變數：</p>
<ul>
<li>全域變數（Global Variable）<ul>
<li>在 function 外宣告的變數</li>
<li>任何地方皆能存取到</li>
</ul>
</li>
<li>區域變數（Local Variable）<ul>
<li>在 function 內宣告的變數</li>
<li>只在該作用域內有效，也就是 function 本身及其內部</li>
</ul>
</li>
</ul>
<h3 id="Function-Scope-可能發生的問題"><a href="#Function-Scope-可能發生的問題" class="headerlink" title="Function Scope 可能發生的問題"></a>Function Scope 可能發生的問題</h3><p>接著要來談談 function 作用域中可能遇到的狀況，這可能會導致結果和想像的不同。</p>
<h4 id="狀況一：變數的值被覆蓋"><a href="#狀況一：變數的值被覆蓋" class="headerlink" title="狀況一：變數的值被覆蓋"></a>狀況一：變數的值被覆蓋</h4><p>若 var 變數不是宣告在 function 作用域內，而是在迴圈或是判斷式，這個變數可能就會覆蓋到外面的全域函數，造成變數汙染。</p>
<p>在下面的程式碼中，if 判斷式裡面的變數 str，會覆蓋外面的變數 str，因此結果是印出 Local：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'Global'</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'Local'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Local</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="狀況二：迴圈變數可能會向外覆蓋全域變數"><a href="#狀況二：迴圈變數可能會向外覆蓋全域變數" class="headerlink" title="狀況二：迴圈變數可能會向外覆蓋全域變數"></a>狀況二：迴圈變數可能會向外覆蓋全域變數</h4><p>當 for 迴圈中的變數 i 循環結束時，會蓋過外面的全域變數 i，因此 function 外面的 i 會被重新賦值為 3：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'cat'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> str<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 向外覆蓋全域變數</span>
<span class="token punctuation">&#125;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// c</span>
<span class="token comment">// a</span>
<span class="token comment">// t</span>
<span class="token comment">// 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="E6-以後的作用域：Block-Scope"><a href="#E6-以後的作用域：Block-Scope" class="headerlink" title="E6 以後的作用域：Block Scope"></a>E6 以後的作用域：Block Scope</h3><p>接著再回到 ES6，新增了區塊作用域（block scope）的概念，也就是以 let 和 const 來宣告變數。</p>
<p>在第三週的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hlaWRpbGl1MjAyMC90aGlzLWlzLWNvZGVkaWFyeS9ibG9iL21hc3Rlci93ZWVrM19FUzYlMjBucG0lMjBKZXN0Lm1kI2VzNi0lRTYlOTYlQjAlRTglQUElOUUlRTYlQjMlOTU=">ES6 部份<i class="fa fa-external-link-alt"></i></span>我們也曾提到，以 let、const 或 var 方式來宣告變數，最大的差別在於變數的作用域範圍不同：</p>
<ul>
<li>var：作用於整個函數範圍中（function scope）</li>
<li>let 與 const：均為區塊作用域（block scope），如此可避免污染到大括號 <code>&#123;...&#125;</code> 外的變數</li>
</ul>
<p>而 let 和 const 最大的區別，在於該變數是否能被重新賦值：</p>
<ul>
<li>const（constant）：常數宣告後就不能再重新賦值，並且在宣告時就必須賦值</li>
<li>let：可重新賦值，也可先進行宣告但不賦值</li>
</ul>
<p>以下面程式碼為例，說明以 var 和 let 宣告變數會有什麼差別：</p>
<h4 id="用-var-在-for-迴圈宣告變數-i"><a href="#用-var-在-for-迴圈宣告變數-i" class="headerlink" title="用 var 在 for 迴圈宣告變數 i"></a>用 var 在 for 迴圈宣告變數 i</h4><p>先以 var 來宣告變數 i，for 迴圈結束後，外面的 log 結果是 3：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'i:'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'final value'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// i: 0</span>
<span class="token comment">// i: 1</span>
<span class="token comment">// i: 2</span>
<span class="token comment">// final value 3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="用-let-在-for-迴圈宣告變數-i"><a href="#用-let-在-for-迴圈宣告變數-i" class="headerlink" title="用 let 在 for 迴圈宣告變數 i"></a>用 let 在 for 迴圈宣告變數 i</h4><p>若改用 let 在 for 迴圈宣告變數，則會出現錯誤 <code>i is not defined</code>：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'i:'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// </span>
  <span class="token punctuation">&#125;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'final value'</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ReferenceError: i is not defined</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這是因為以 let 進行宣告，變數 i 的作用域就僅限於 for 迴圈這個 block 區塊，所以大括號外面就無法存取到變數 i。</p>
<h3 id="作用域會往外層找"><a href="#作用域會往外層找" class="headerlink" title="作用域會往外層找"></a>作用域會往外層找</h3><p>記住這個重點：「作用與會往外層找」。也就是說，在 function 外面會存取不到裡面，但內層可以存取到外層的東西。</p>
<p>舉下面幾個程式碼作為範例。</p>
<h4 id="範例一：從-function-外往內存取變數"><a href="#範例一：從-function-外往內存取變數" class="headerlink" title="範例一：從 function 外往內存取變數"></a>範例一：從 function 外往內存取變數</h4><p>結果會出現錯誤 <code>a is not defined</code>：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ReferenceError: a is not defined`</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這是因為在 function 外面沒辦法存取內部的變數 a，所以會出現錯誤。</p>
<h4 id="範例二：存取-function-以及-global-變數"><a href="#範例二：存取-function-以及-global-變數" class="headerlink" title="範例二：存取 function 以及 global 變數"></a>範例二：存取 function 以及 global 變數</h4><p>若分別宣告全域變數和區域變數，log 結果不會互相干擾：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">20</span>          <span class="token comment">// global variable</span>
<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>       <span class="token comment">// function variable </span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 10</span>
<span class="token punctuation">&#125;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="範例三：直接在-function-內部賦值"><a href="#範例三：直接在-function-內部賦值" class="headerlink" title="範例三：直接在 function 內部賦值"></a>範例三：直接在 function 內部賦值</h4><p>結果全域和區域的兩個 a，其 log 結果會相同：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>          <span class="token comment">// global variable</span>
<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 10，function -> global</span>
<span class="token punctuation">&#125;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>原因在於，即使 function 內沒有宣告變數，仍會「往外」找到已經被宣告的全域變數 <code>var a</code>，然後再回到內部賦值 <code>a = 10</code>。</p>
<p>變數會先在自己的作用域找，若找不到會繼續再往外找，一層一層直到找到為止。而這一連串的行為，就稱作 Scope Chain（作用域鏈），詳細內容稍後會再進行說明。</p>
<h4 id="範例四：function-內外都沒有宣告變數"><a href="#範例四：function-內外都沒有宣告變數" class="headerlink" title="範例四：function 內外都沒有宣告變數"></a>範例四：function 內外都沒有宣告變數</h4><p>結果仍會和上述範例相同！</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 10，test -> global</span>
<span class="token punctuation">&#125;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>這是因為，在 function 中如果 a 找不到值，就會往外層找，如果全域也找不到，就會自動宣告全域變數 <code>var a</code>。</p>
<p>這會和前一個例子寫法產生相同結果，但這種情況其實會產生一些 bug，也就是和預期行為不同，甚至可能產生衝突。</p>
<h2 id="Scope-Chain-作用域鏈"><a href="#Scope-Chain-作用域鏈" class="headerlink" title="Scope Chain 作用域鏈"></a>Scope Chain 作用域鏈</h2><p>在說明之前，先來看以下範例：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">100</span>
  <span class="token keyword">function</span> <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// 100</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 inner() 中，a 並非該函式中的變數，而這種不在該 function 作用域中，也不是作為參數傳進來的變數，就被稱為 Free Variable（自由變數）。</p>
<p>對 inner() 來說，a 是一個自由變數。因為在 inner() 的作用域中找不到 a，就會往外層 test() 找，如果還是找不到會再往外直到找到為止。</p>
<p>這其實就構成一個 Scope Chain（作用域鏈）：inner function scope -&gt; test function scope -&gt; global scope，如果直到全域作用域還是找不到，就會拋出錯誤。</p>
<p>還記得我們在開頭提到，每個執行環境物件會有下列三個屬性：</p>
<ul>
<li>作用域鏈（Scope Chain）</li>
<li>變數物件（Variable Object）</li>
<li>‘this’ 變數（‘this’ Variable）</li>
</ul>
<p>而 Scope Chain 這個屬性，其實就是負責記錄「包含自己的 VO + 所有上層執行環境的 VO」的集合。藉由該屬性，函式內部就可以存取到外部的變數。　</p>
<p>聽起來有點抽像，我們舉個簡單的例子：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">two</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token function">three</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">three</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 6</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>從 Global Context 呼叫 one()，one() 再呼叫 two()，接著再呼叫 three()，最後在 function three 執行 console.log()。下圖在建立階段的堆疊示意圖：</p>
<p><img src="https://i.imgur.com/RtkT8LP.png"></p>
<p>當 JavaScript 要執行 <code>console.log(a + b + c)</code> 這行程式，會不斷往 Scope Chain 去尋找。</p>
<p>就像前面所說的，一開始會先在自己的 VO 找，找不到在換下一個，一直到 global 為止，如果找不到就會拋出錯誤。過程如下圖：</p>
<p><img src="https://i.imgur.com/9ROutJb.png"></p>
<p>（圖片來源：<span class="exturl" data-url="aHR0cHM6Ly9hbmR5eW91LmdpdGh1Yi5pby8yMDE1LzA0LzIwL3VuZGVyc3RhbmQtY2xvc3VyZXMtYW5kLXNjb3BlLWNoYWluLw==">https://andyyou.github.io/2015/04/20/understand-closures-and-scope-chain/<i class="fa fa-external-link-alt"></i></span> ）</p>
<h3 id="ECMAScript-中的作用域"><a href="#ECMAScript-中的作用域" class="headerlink" title="ECMAScript 中的作用域"></a>ECMAScript 中的作用域</h3><p>每個執行環境都有一個 Scope Chain。也就是說，一旦進入該執行環境，就會建立 Scope Chain 並進行初始化。</p>
<p>以 global 執行環境來說，初始化後會把 VO 放進 Scope Chain 內，可表示為：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">scopeChain <span class="token operator">=</span> <span class="token punctuation">[</span>globalEC<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此外，每個函式都有一個 [[Scope]] 屬性，當 global 執行環境遇到函式時，會將它初始化為 global 執行環境的 Scope Chain：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> globalEC<span class="token punctuation">.</span>scopeChain<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>當函式被呼叫時，會建立 local 執行環境，也會建立 VO，在函式中會稱作 Activation Object（AO），並且除了 AO 之外，外面傳進來的參數也會被加到該 local 執行環境的 Scope Chain：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span><span class="token punctuation">.</span>scopeChain <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">.</span><span class="token constant">AO</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="模擬-JS-實際流程"><a href="#模擬-JS-實際流程" class="headerlink" title="模擬 JS 實際流程"></a>模擬 JS 實際流程</h3><p>舉個簡單的範例：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="第一步：進入-Global-執行環境"><a href="#第一步：進入-Global-執行環境" class="headerlink" title="第一步：進入 Global 執行環境"></a>第一步：進入 Global 執行環境</h4><p>首先進入 Global EC，並初始化 VO 以及 scope chain。前面提到 scope chain = activation object + [[Scope]]，但因為這不是一個 function，所以沒有[[Scope]] 和 AO，會直接以 VO 來用：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">global <span class="token constant">EC</span> <span class="token punctuation">&#123;</span>
  <span class="token constant">VO</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    a<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token function-variable function">test</span><span class="token operator">:</span> <span class="token keyword">function</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  scopeChain<span class="token operator">:</span> <span class="token punctuation">[</span>globalEC<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

test<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> globalEC<span class="token punctuation">.</span>scopeChain<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此外也需設置 function 的 [[Scope]]，所以 test() 的[[Scope]] 就會是 globalEC.scopeChain，也就是 globalEC.VO。</p>
<h4 id="第二步：建立-test-執行環境"><a href="#第二步：建立-test-執行環境" class="headerlink" title="第二步：建立 test 執行環境"></a>第二步：建立 test 執行環境</h4><p>執行完 <code>var a = 1</code> 後，將 global EC 的 VO 初始為 1。</p>
<p>接著準備進入 test()，在進入之前會先建立 test EC 並初始化 AO 以及 scope chain ：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">testEC<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token constant">AO</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    b<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token function-variable function">inner</span><span class="token operator">:</span> <span class="token keyword">function</span>
  <span class="token punctuation">&#125;</span>
    scopeChain<span class="token operator">:</span> <span class="token punctuation">[</span>testEC<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token punctuation">,</span> test<span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token operator">=></span> <span class="token punctuation">[</span>testEC<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token punctuation">,</span> globalEC<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

inner<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> testEC<span class="token punctuation">.</span>scopeChain
<span class="token operator">=</span> <span class="token punctuation">[</span>testEC<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token punctuation">,</span> test<span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

<span class="token operator">===</span><span class="token operator">===</span>

global <span class="token constant">EC</span> <span class="token punctuation">&#123;</span>
  <span class="token constant">VO</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token function-variable function">test</span><span class="token operator">:</span> <span class="token keyword">function</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  scopeChain<span class="token operator">:</span> <span class="token punctuation">[</span>globalEC<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

test<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> globalEC<span class="token punctuation">.</span>scopeChain
<span class="token operator">=</span> <span class="token punctuation">[</span>globalEC<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同裡，需設置 function inner() 的 [[Scope]]，可表示為 testEC.scopeChain，又等同於 [testEC.AO, test[[Scope]]]。</p>
<h4 id="第三步：建立-inner-執行環境"><a href="#第三步：建立-inner-執行環境" class="headerlink" title="第三步：建立 inner 執行環境"></a>第三步：建立 inner 執行環境</h4><p>執行完 <code>var b = 2</code> 後，將 test EC 的 AO 初始為 2。</p>
<p>接著進入 inner() 時同樣會建立 inner EC 跟 AO 建立，然後執行完 <code>var c = 3</code> 後，將 inner EC 的 AO 初始為 3：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">innerEC<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token constant">AO</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    c<span class="token operator">:</span> <span class="token number">3</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  scopeChain<span class="token operator">:</span> <span class="token punctuation">[</span>innerEC<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token punctuation">,</span> inner<span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token operator">=></span> <span class="token punctuation">[</span>inner<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token punctuation">,</span> testEC<span class="token punctuation">.</span>scopeChain<span class="token punctuation">]</span>
    <span class="token operator">=></span> <span class="token punctuation">[</span>inner<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token punctuation">,</span> testEC<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token punctuation">,</span> globalEC<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

testEC<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token constant">AO</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    b<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token function-variable function">inner</span><span class="token operator">:</span> <span class="token keyword">function</span>
  <span class="token punctuation">&#125;</span>
    scopeChain<span class="token operator">:</span> <span class="token punctuation">[</span>testEC<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token punctuation">,</span> test<span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token operator">=></span> <span class="token punctuation">[</span>testEC<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token punctuation">,</span> globalEC<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

inner<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> testEC<span class="token punctuation">.</span>scopeChain
<span class="token operator">=</span> <span class="token punctuation">[</span>testEC<span class="token punctuation">.</span><span class="token constant">AO</span><span class="token punctuation">,</span> test<span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

<span class="token operator">===</span><span class="token operator">===</span>

global <span class="token constant">EC</span> <span class="token punctuation">&#123;</span>
  <span class="token constant">VO</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token function-variable function">test</span><span class="token operator">:</span> <span class="token keyword">function</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  scopeChain<span class="token operator">:</span> <span class="token punctuation">[</span>globalEC<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

test<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">[</span>Scope<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> globalEC<span class="token punctuation">.</span>scopeChain
<span class="token operator">=</span> <span class="token punctuation">[</span>globalEC<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="第四部：執行程式碼"><a href="#第四部：執行程式碼" class="headerlink" title="第四部：執行程式碼"></a>第四部：執行程式碼</h4><ul>
<li>執行到 <code>console.log(c)</code><ul>
<li>在 <code>innerEC.AO</code> 裡面找到 c = 3</li>
</ul>
</li>
<li>執行到 <code>console.log(b)</code><ul>
<li>在 <code>innerEC.AO</code> 裡找不到</li>
<li>沿著 scopeChain 往上找到 <code>testEC.AO</code> 裡面 b = 2</li>
</ul>
</li>
<li>執行到 <code>console.log(a)</code><ul>
<li>在 <code>innerEC.AO</code> 裡找不到</li>
<li>沿著 scopeChain 往上找到 <code>globalEC.AO</code> 裡面 a = 3</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 2</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如同前面所說，其實 Scope Chain 就是 VO/AO 的組合，是負責記錄「包含自己的 VO + 所有上層執行環境的 VO」的集合。</p>
<p>藉由編譯完成時的 EC 模型，我們可瞭解程式在執行時，是如何在 AO 或 VO 裡面找到宣告過的變數，若在該作用域找不到，就會沿著 scopeChain 不斷會往上一層找。</p>
<p>這其實能夠解釋之前提過的 Hoisting（提升），還有接下來要探討的 Closure（提升）是如何發生。</p>
<h3 id="Lexical-Scope-vs-Dynamic-Scope"><a href="#Lexical-Scope-vs-Dynamic-Scope" class="headerlink" title="Lexical Scope vs Dynamic Scope"></a>Lexical Scope vs Dynamic Scope</h3><p>有了基本概念後，再來看下列範例，其中 a 的 log 值會是多少呢？</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">100</span>
<span class="token keyword">function</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// 100 or 200?</span>
<span class="token punctuation">&#125;</span>
  
<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">200</span>
  <span class="token function">echo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
  
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>結果會是 100，echo() 裡面的 a 就是 global 的 a，和 test() 裡面的 a 一點關係都沒有。</p>
<p>這和程式語言是如何決定「作用域」這件事有關，可分為靜態作用域和動態作用域：</p>
<ul>
<li>Static Scope 靜態作用域<ul>
<li>又可稱為 Lexical Scope 語法作用域、語彙範疇</li>
<li>變數的作用域在語法解析時，就已經確定作用域，且不會改變</li>
</ul>
</li>
<li>Dynamic Scope 動態作用域<ul>
<li>變數的作用域在函式調用時才決定</li>
<li>若是採用動態作用域的程式語言，那最後 log 出來的值就會是 200 而不是 100</li>
</ul>
</li>
</ul>
<p>而 JavaScript 採用的是靜態作用域，在分析程式碼的結構就可以知道作用域的長相。但需特別注意的是，JavaScript 中的 <code>this</code>，其原理和動態作用域非常類似，this 的值會在程式執行時才被動態決定。</p>
<p>建立一些有關作用域的觀念後，再來我們要來談談本篇核心：Closure（閉包）。</p>
<hr>
<h2 id="Closure-閉包"><a href="#Closure-閉包" class="headerlink" title="Closure 閉包"></a>Closure 閉包</h2><p>在 JavaScript 中，Closure（閉包）和作用域的關係密不可分，透過 Scope Chain 的機制，我們能夠進一步理解 Closure 產生的原因。</p>
<p>可先來看看下方這個例子：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    a<span class="token operator">++</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> inner <span class="token comment">// 不加括號，只 return 這個 function</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">var</span> func <span class="token operator">=</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 11 => 等同於 inner()</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 12 => 等同於 inner()</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 13 => 等同於 inner()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>透過在 function 中回傳另一個 function 的寫法，就可以把 a 這個變數鎖在這個 function 裡面，隨時能夠拿出來使用。</p>
<p>一般而言，當 function 被執行完之後，資源就會被釋放掉，但是通過這種寫法，我們就可以把 function 內部變數的值給保存起來。</p>
<p>再根據 <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtVFcvZG9jcy9XZWIvSmF2YVNjcmlwdC9DbG9zdXJlcw==">MDN<i class="fa fa-external-link-alt"></i></span> 說明，其實閉包就是一個特殊的物件，具有下列兩個含義：</p>
<ul>
<li>它是一個 function</li>
<li>它產生了一個 context 執行環境，負責記錄上層 VO</li>
</ul>
<p>再舉個有關 Closure 的例子：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> brand <span class="token operator">=</span> <span class="token string">"BMW"</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">car</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"This is a "</span> <span class="token operator">+</span> brand <span class="token operator">+</span> <span class="token string">" car"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">var</span> carMaker <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">carMaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//  "This is a BMW car</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述程式碼建立的 EC 模型：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Global Context</span>
global<span class="token punctuation">.</span><span class="token constant">VO</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  factory<span class="token operator">:</span> pointer to <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  carMaker<span class="token operator">:</span> 是 global<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">.</span>factory 的回傳值
  scopeChain<span class="token operator">:</span> <span class="token punctuation">[</span>global<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Factory 執行環境</span>
factory<span class="token punctuation">.</span><span class="token constant">VO</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  car<span class="token operator">:</span> pointer to <span class="token function">car</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  brand<span class="token operator">:</span> <span class="token string">'BMW'</span><span class="token punctuation">,</span>
  scopeChain<span class="token operator">:</span> <span class="token punctuation">[</span>factory<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">,</span> global<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// car 執行環境</span>
car<span class="token punctuation">.</span><span class="token constant">VO</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  scopeChain <span class="token operator">=</span> <span class="token punctuation">[</span>car<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">,</span> factory<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">,</span> global<span class="token punctuation">.</span><span class="token constant">VO</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以 JS 運作過程來說， function factory 執行結束後就會從 Call Stack 移除，但是因為 VO 還會被 car VO 參考，所以不會將其移除。</p>
<p>這其實就是前面所提到的 Scope Chain 與 Closure 之間的關係。</p>
<h3 id="操作-Closure-可能遇到的作用域陷阱"><a href="#操作-Closure-可能遇到的作用域陷阱" class="headerlink" title="操作 Closure 可能遇到的作用域陷阱"></a>操作 Closure 可能遇到的作用域陷阱</h3><p>由以下範例，可發現執行 <code>arr[0]()</code> 時，結果會是 5：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>當執行 <code>arr[0]()</code> 時，其實會長這樣：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>因為 function EC 中沒有宣告變數 i，因此會往上一層作用域找，找到 global EC 的 i，又因為 for 迴圈執行結束，此時的 i = 5，所以會印出 5。</p>
<p>可使用下列方法改寫上述程式碼：</p>
<h4 id="1-使用閉包：在-function-中-return-function"><a href="#1-使用閉包：在-function-中-return-function" class="headerlink" title="1. 使用閉包：在 function 中 return function"></a>1. 使用閉包：在 function 中 return function</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">logN</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">logN</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-IIFE：立即呼叫函式"><a href="#2-IIFE：立即呼叫函式" class="headerlink" title="2. IIFE：立即呼叫函式"></a>2. IIFE：立即呼叫函式</h4><ul>
<li>IIFE：Immediately Invoked Function Expression，是一個在宣告的當下就會馬上被執行的函數。語法如下：</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// hello</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>因此範例程式碼可修改成，這樣就不用再另外宣告 function，但缺點是可讀性較差：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-使用-let-宣告：限定變數的作用域"><a href="#3-使用-let-宣告：限定變數的作用域" class="headerlink" title="3. 使用 let 宣告：限定變數的作用域"></a>3. 使用 let 宣告：限定變數的作用域</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>執行 <code>arr[0]()</code> 時可以表示成：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Closure-實際應用"><a href="#Closure-實際應用" class="headerlink" title="Closure 實際應用"></a>Closure 實際應用</h2><p>那我們通常會在什麼情況下使用 Closure 呢？像是在計算量很大的時候，或是需要隱藏一些內部資訊。方法如下：</p>
<h3 id="1-封裝"><a href="#1-封裝" class="headerlink" title="1. 封裝"></a>1. 封裝</h3><p>可將一些不想外露的細節封裝在執行環境中，只露出想要 public 部分。</p>
<p>以下方與金源有關的程式碼為例：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> money <span class="token operator">=</span> <span class="token number">99</span>
<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  money <span class="token operator">+=</span> num
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    money <span class="token operator">-=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">deduct</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>money<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在這種情況之下，任何人都能夠變動 global 中變數 money 的值。</p>
<p>如果改成使用閉包，就能夠把變數給隱藏起來，無法從外部更改 function 內部資料：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createWallet</span><span class="token punctuation">(</span><span class="token parameter">initMoney</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> money <span class="token operator">=</span> initMoney<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
    <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      money <span class="token operator">+=</span> num<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">deduct</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        money <span class="token operator">-=</span> <span class="token number">10</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        money <span class="token operator">-=</span> num
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> money<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">var</span> myWallet <span class="token operator">=</span> <span class="token function">createWallet</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myWallet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myWallet<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myWallet<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 90</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-Callbacks-回呼"><a href="#2-Callbacks-回呼" class="headerlink" title="2. Callbacks 回呼"></a>2. Callbacks 回呼</h3><p>callback funtcion 就是一種常見的閉包。先前提到像 JavaScript 就是採用單執行緒與 Event Loop 機制，一次只能處理一件事情。</p>
<p>但以 callback 能讓我們能夠延遲函式的調用，實現非同步操作。例如呼叫一個 AJAX 的 XMLHttpRequest，通常就會使用 callback 來處理伺服器的回應，因此等待時其他程式還是能照常運作。</p>
<h2 id="何時不該使用-Clousre？"><a href="#何時不該使用-Clousre？" class="headerlink" title="何時不該使用 Clousre？"></a>何時不該使用 Clousre？</h2><p>雖然 Closure 提供非常便利的功能，但因為系統效能的因素，還是必須謹慎使用：</p>
<h3 id="1-過多的作用域"><a href="#1-過多的作用域" class="headerlink" title="1. 過多的作用域"></a>1. 過多的作用域</h3><p>需注意每當需要取得一個變數時，Scope Chain 會一層一層檢索，直到找到該物件或值，因此越多層會導致需時越長，例如多個巢狀 function。</p>
<h3 id="2-記憶體回收"><a href="#2-記憶體回收" class="headerlink" title="2. 記憶體回收"></a>2. 記憶體回收</h3><p>記憶體回收（Garbage Collection）機制，簡單來說，就是當物件不再被參考時，就會被記憶體回收處理。</p>
<p>但如果是在不正確使用閉包的情況下，就可能導致記憶體洩漏（Memory Leak），造成程式未能釋放已經不再使用的記憶體，並產生效能問題。</p>
<p>以下方的程式碼為例：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">leakyFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  leak <span class="token operator">=</span> <span class="token number">100</span>
<span class="token punctuation">&#125;</span>
<span class="token function">leakyFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>leak<span class="token punctuation">)</span>  <span class="token comment">// 100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>若在非 strict 模式下執行，JavaScript 會自動宣告一個全域變數 <code>var leak</code>，因此就算函數執行完畢，leak 還是會繼續存留在 全域環境中，因此也就不會被回收掉。</p>
<hr>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>在學到 Closure（閉包）時，發現到花了很多時間在瞭解有關 Scope（作用域）的概念。也是在這一單元瞭解到，原來之前在課程學到的非同步操作，當中的 callback 其實就和閉包有關，有關 callback 的觀念真的非常重要！</p>
<p>此外也瞭解到，閉包在框架中很常會使用到，透過閉包的方式，就能夠避免汙染全域變數或是記憶體洩漏等問題。</p>
<p>一開始之所以沒辦法很快理解，或許就是沒有把這些觀念融會貫通，都是一個環節接著另一個環節，和 Scope Chain 一樣，會需要往上一層去找出需要的拼圖。</p>
<p>參考資料：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmh1bGkudHcvMjAxOC8xMi8wOC9qYXZhc2NyaXB0LWNsb3N1cmUv">所有的函式都是閉包：談 JS 中的作用域與 Closure<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9hbmR5eW91LmdpdGh1Yi5pby8yMDE1LzA0LzIwL3VuZGVyc3RhbmQtY2xvc3VyZXMtYW5kLXNjb3BlLWNoYWluLw==">參透Javascript閉包與Scope Chain<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9odWdoLXByb2dyYW0tbGVhcm5pbmctZGlhcnktanMubWVkaXVtLmNvbS8lRTUlODklOEQlRTclQUIlQUYlRTQlQjglQUQlRTklOUElOEUtanMlRTQlQkIlQTQlRTQlQkElQkElRTYlOTAlOUUlRTQlQjglOEQlRTYlODclODIlRTclOUElODQlRTUlOUMlQjAlRTYlOTYlQjktY2xvc3VyZS0lRTklOTYlODklRTUlOEMlODUtY2JiOWM2YTQxODVj">前端中階：JS令人搞不懂的地方-Closure(閉包)<i class="fa fa-external-link-alt"></i></span></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
              <a href="/tags/Closure/" rel="tag"># Closure</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/javascript-hoisting/" rel="prev" title="[week 16] JavaScript 進階 - 初探 Hoisting & Execution Context">
      <i class="fa fa-chevron-left"></i> [week 16] JavaScript 進階 - 初探 Hoisting & Execution Context
    </a></div>
      <div class="post-nav-item">
    <a href="/javascript-oop-prototype/" rel="next" title="[week 16] JavaScript 進階 - 物件導向 & Prototype">
      [week 16] JavaScript 進階 - 物件導向 & Prototype <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
          <div style="">
            
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4274798044223706"
     crossorigin="anonymous"></script>
  <!-- ad_0113 -->
  <ins class="adsbygoogle"
      style="display:block"
      data-ad-client="ca-pub-4274798044223706"
      data-ad-slot="7260167051"
      data-ad-format="auto"
      data-full-width-responsive="true"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

          </div>
        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Scope-%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">1.</span> <span class="nav-text">Scope 作用域</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Function-Scope-%E5%8F%AF%E8%83%BD%E7%99%BC%E7%94%9F%E7%9A%84%E5%95%8F%E9%A1%8C"><span class="nav-number">1.1.</span> <span class="nav-text">Function Scope 可能發生的問題</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8B%80%E6%B3%81%E4%B8%80%EF%BC%9A%E8%AE%8A%E6%95%B8%E7%9A%84%E5%80%BC%E8%A2%AB%E8%A6%86%E8%93%8B"><span class="nav-number">1.1.1.</span> <span class="nav-text">狀況一：變數的值被覆蓋</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8B%80%E6%B3%81%E4%BA%8C%EF%BC%9A%E8%BF%B4%E5%9C%88%E8%AE%8A%E6%95%B8%E5%8F%AF%E8%83%BD%E6%9C%83%E5%90%91%E5%A4%96%E8%A6%86%E8%93%8B%E5%85%A8%E5%9F%9F%E8%AE%8A%E6%95%B8"><span class="nav-number">1.1.2.</span> <span class="nav-text">狀況二：迴圈變數可能會向外覆蓋全域變數</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#E6-%E4%BB%A5%E5%BE%8C%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F%EF%BC%9ABlock-Scope"><span class="nav-number">1.2.</span> <span class="nav-text">E6 以後的作用域：Block Scope</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8-var-%E5%9C%A8-for-%E8%BF%B4%E5%9C%88%E5%AE%A3%E5%91%8A%E8%AE%8A%E6%95%B8-i"><span class="nav-number">1.2.1.</span> <span class="nav-text">用 var 在 for 迴圈宣告變數 i</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8-let-%E5%9C%A8-for-%E8%BF%B4%E5%9C%88%E5%AE%A3%E5%91%8A%E8%AE%8A%E6%95%B8-i"><span class="nav-number">1.2.2.</span> <span class="nav-text">用 let 在 for 迴圈宣告變數 i</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8%E5%9F%9F%E6%9C%83%E5%BE%80%E5%A4%96%E5%B1%A4%E6%89%BE"><span class="nav-number">1.3.</span> <span class="nav-text">作用域會往外層找</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AF%84%E4%BE%8B%E4%B8%80%EF%BC%9A%E5%BE%9E-function-%E5%A4%96%E5%BE%80%E5%85%A7%E5%AD%98%E5%8F%96%E8%AE%8A%E6%95%B8"><span class="nav-number">1.3.1.</span> <span class="nav-text">範例一：從 function 外往內存取變數</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AF%84%E4%BE%8B%E4%BA%8C%EF%BC%9A%E5%AD%98%E5%8F%96-function-%E4%BB%A5%E5%8F%8A-global-%E8%AE%8A%E6%95%B8"><span class="nav-number">1.3.2.</span> <span class="nav-text">範例二：存取 function 以及 global 變數</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AF%84%E4%BE%8B%E4%B8%89%EF%BC%9A%E7%9B%B4%E6%8E%A5%E5%9C%A8-function-%E5%85%A7%E9%83%A8%E8%B3%A6%E5%80%BC"><span class="nav-number">1.3.3.</span> <span class="nav-text">範例三：直接在 function 內部賦值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AF%84%E4%BE%8B%E5%9B%9B%EF%BC%9Afunction-%E5%85%A7%E5%A4%96%E9%83%BD%E6%B2%92%E6%9C%89%E5%AE%A3%E5%91%8A%E8%AE%8A%E6%95%B8"><span class="nav-number">1.3.4.</span> <span class="nav-text">範例四：function 內外都沒有宣告變數</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scope-Chain-%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%8F%88"><span class="nav-number">2.</span> <span class="nav-text">Scope Chain 作用域鏈</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ECMAScript-%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">2.1.</span> <span class="nav-text">ECMAScript 中的作用域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%93%AC-JS-%E5%AF%A6%E9%9A%9B%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.</span> <span class="nav-text">模擬 JS 實際流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E9%80%B2%E5%85%A5-Global-%E5%9F%B7%E8%A1%8C%E7%92%B0%E5%A2%83"><span class="nav-number">2.2.1.</span> <span class="nav-text">第一步：進入 Global 執行環境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%BB%BA%E7%AB%8B-test-%E5%9F%B7%E8%A1%8C%E7%92%B0%E5%A2%83"><span class="nav-number">2.2.2.</span> <span class="nav-text">第二步：建立 test 執行環境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E5%BB%BA%E7%AB%8B-inner-%E5%9F%B7%E8%A1%8C%E7%92%B0%E5%A2%83"><span class="nav-number">2.2.3.</span> <span class="nav-text">第三步：建立 inner 執行環境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%83%A8%EF%BC%9A%E5%9F%B7%E8%A1%8C%E7%A8%8B%E5%BC%8F%E7%A2%BC"><span class="nav-number">2.2.4.</span> <span class="nav-text">第四部：執行程式碼</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lexical-Scope-vs-Dynamic-Scope"><span class="nav-number">2.3.</span> <span class="nav-text">Lexical Scope vs Dynamic Scope</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Closure-%E9%96%89%E5%8C%85"><span class="nav-number">3.</span> <span class="nav-text">Closure 閉包</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C-Closure-%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%99%B7%E9%98%B1"><span class="nav-number">3.1.</span> <span class="nav-text">操作 Closure 可能遇到的作用域陷阱</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E4%BD%BF%E7%94%A8%E9%96%89%E5%8C%85%EF%BC%9A%E5%9C%A8-function-%E4%B8%AD-return-function"><span class="nav-number">3.1.1.</span> <span class="nav-text">1. 使用閉包：在 function 中 return function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-IIFE%EF%BC%9A%E7%AB%8B%E5%8D%B3%E5%91%BC%E5%8F%AB%E5%87%BD%E5%BC%8F"><span class="nav-number">3.1.2.</span> <span class="nav-text">2. IIFE：立即呼叫函式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E4%BD%BF%E7%94%A8-let-%E5%AE%A3%E5%91%8A%EF%BC%9A%E9%99%90%E5%AE%9A%E8%AE%8A%E6%95%B8%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">3.1.3.</span> <span class="nav-text">3. 使用 let 宣告：限定變數的作用域</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Closure-%E5%AF%A6%E9%9A%9B%E6%87%89%E7%94%A8"><span class="nav-number">4.</span> <span class="nav-text">Closure 實際應用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%B0%81%E8%A3%9D"><span class="nav-number">4.1.</span> <span class="nav-text">1. 封裝</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Callbacks-%E5%9B%9E%E5%91%BC"><span class="nav-number">4.2.</span> <span class="nav-text">2. Callbacks 回呼</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%95%E6%99%82%E4%B8%8D%E8%A9%B2%E4%BD%BF%E7%94%A8-Clousre%EF%BC%9F"><span class="nav-number">5.</span> <span class="nav-text">何時不該使用 Clousre？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%81%8E%E5%A4%9A%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">5.1.</span> <span class="nav-text">1. 過多的作用域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%A8%98%E6%86%B6%E9%AB%94%E5%9B%9E%E6%94%B6"><span class="nav-number">5.2.</span> <span class="nav-text">2. 記憶體回收</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B5%90%E8%AA%9E"><span class="nav-number">6.</span> <span class="nav-text">結語</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Heidi Liu"
      src="https://avatars3.githubusercontent.com/u/65410665?s=460&u=887bd602944dcf78b90f3a880b03aec4e086728a&v=4">
  <p class="site-author-name" itemprop="name">Heidi Liu</p>
  <div class="site-description" itemprop="description">海底修羅場｜日々進化中</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">57</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hlaWRpbGl1MjAyMA==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;heidiliu2020"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9oZWlkaS1jb2RpbmcubWVkaXVtLmNvbS8=" title="Medium → https:&#x2F;&#x2F;heidi-coding.medium.com&#x2F;"><i class="fab fa-medium fa-fw"></i>Medium</span>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Heidi Liu</span>
</div>
  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Gemini</span> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='220,220,220' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

<script>
  var disqus_config = function() {
    this.page.url = "https://heidiliu2020.github.io/javascript-closure/";
    this.page.identifier = "javascript-closure/";
    this.page.title = "[week 16] JavaScript 進階 - 什麼是閉包？探討 Closure & Scope Chain";
    this.language = "zh_TW"; 
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://heidiblog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

    </div>
</body>
</html>
